<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Bulk iCal Generator (Cards ‚Ä¢ List ‚Ä¢ Calendar)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- TailwindCSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide Icons (UMD) -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

  <!-- FullCalendar (global builds) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

  <style>
    /* Mobile modal fullscreen body height helper */
    @media (max-width: 640px) {
      .modal-body { height: calc(100vh - 136px); } /* header+footer approx */
    }
    /* Small tweak so calendar fits nicely inside our panel */
    #calendar { --fc-border-color: #e5e7eb; } /* Tailwind gray-200 for grid lines */
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 p-4 md:p-8">
  <div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8 mb-6 border border-gray-100">
      <div class="flex items-center gap-4 mb-4">
        <div class="bg-gradient-to-br from-indigo-500 to-purple-600 p-3 rounded-xl shadow-lg">
          <i data-lucide="calendar" class="w-8 h-8 text-white"></i>
        </div>
        <div>
          <h1 class="text-3xl md:text-4xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">
            Bulk iCal Generator
          </h1>
          <p class="text-gray-600 text-sm mt-1">Create multiple calendar events in one go</p>
        </div>
      </div>

      <!-- Actions: stack on small, inline on md+ -->
      <div class="flex flex-col sm:flex-row sm:flex-wrap gap-3 mt-6">
        <button id="btnAdd"
          class="w-full sm:w-auto inline-flex items-center justify-center gap-2 bg-gradient-to-r from-indigo-600 to-indigo-700 text-white px-6 py-3 rounded-xl hover:from-indigo-700 hover:to-indigo-800 transition-all shadow-md hover:shadow-lg font-medium">
          <i data-lucide="plus" class="w-5 h-5"></i>
          Add Event
        </button>

        <button id="btnToggleCsv"
          class="w-full sm:w-auto inline-flex items-center justify-center gap-2 bg-white border-2 border-indigo-200 text-indigo-700 px-6 py-3 rounded-xl hover:bg-indigo-50 transition-all shadow-md font-medium">
          <i data-lucide="upload" class="w-5 h-5"></i>
          Import CSV
        </button>

        <button id="btnDownload" disabled
          class="w-full sm:w-auto inline-flex items-center justify-center gap-2 px-6 py-3 rounded-xl transition-all shadow-md font-medium bg-gray-200 text-gray-400 cursor-not-allowed">
          <i data-lucide="download" class="w-5 h-5"></i>
          <span id="downloadLabel">Download (0)</span>
        </button>

        <button id="btnDeleteSelected" style="display:none"
          class="w-full sm:w-auto inline-flex items-center justify-center gap-2 bg-gradient-to-r from-red-600 to-rose-600 text-white px-6 py-3 rounded-xl hover:from-red-700 hover:to-rose-700 transition-all shadow-md hover:shadow-lg font-medium">
          <i data-lucide="trash-2" class="w-5 h-5"></i>
          <span id="deleteLabel">Delete (0)</span>
        </button>
      </div>
    </div>

    <!-- Empty state -->
    <div id="emptyState" class="bg-white rounded-2xl shadow-xl p-8 sm:p-12 border border-gray-100 text-center">
      <div class="bg-gradient-to-br from-indigo-100 to-purple-100 w-16 h-16 sm:w-20 sm:h-20 rounded-full flex items-center justify-center mx-auto mb-6">
        <i data-lucide="calendar" class="w-8 h-8 sm:w-10 sm:h-10 text-indigo-600"></i>
      </div>
      <h3 class="text-xl sm:text-2xl font-bold text-gray-800 mb-3">Ready to Create Events</h3>
      <p class="text-gray-600 mb-8 max-w-md mx-auto">
        Tap ‚ÄúAdd Event‚Äù to create a calendar invite. Add as many as you need and download them all at once.
      </p>
    </div>

    <!-- Events panel -->
    <div id="eventsPanel" class="hidden bg-white rounded-2xl shadow-xl p-6 border border-gray-100">
      <!-- Header with view toggle -->
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
        <div class="flex items-center gap-2">
          <h3 class="text-xl font-bold text-gray-800">Events</h3>
          <span id="eventsCount" class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-sm font-semibold">0</span>
        </div>

        <div class="flex items-center gap-2">
          <!-- View toggle -->
          <div class="inline-flex rounded-lg border border-gray-200 overflow-hidden">
            <button id="viewCards"
              class="px-3 py-1.5 text-sm bg-white text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500">
              Cards
            </button>
            <button id="viewList"
              class="px-3 py-1.5 text-sm bg-gray-50 text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-indigo-500">
              List
            </button>
            <button id="viewCalendar"
              class="px-3 py-1.5 text-sm bg-gray-50 text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-indigo-500">
              Calendar
            </button>
          </div>

          <button id="btnToggleAll"
            class="self-start sm:self-auto inline-flex items-center gap-2 text-sm text-indigo-600 hover:text-indigo-800 font-medium hover:bg-indigo-50 px-3 py-2 rounded-lg transition-colors">
            <i data-lucide="square" class="w-4 h-4"></i>
            <span id="toggleAllLabel">Select All</span>
          </button>
        </div>
      </div>

      <!-- Quick Add + Presets -->
      <div class="bg-gray-50 border border-gray-200 rounded-xl p-4 mb-4">
        <div class="flex flex-col md:flex-row md:items-center gap-3">
          <div class="flex-1">
            <label for="qa_title" class="block text-xs font-semibold text-gray-600 mb-1">Title</label>
            <input id="qa_title" type="text" placeholder="Quick add title"
              class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all" />
          </div>
          <div>
            <label for="qa_date" class="block text-xs font-semibold text-gray-600 mb-1">Date</label>
            <input id="qa_date" type="date"
              class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all" />
          </div>
          <div>
            <label for="qa_time" class="block text-xs font-semibold text-gray-600 mb-1">Time</label>
            <input id="qa_time" type="time"
              class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all" />
          </div>
          <div class="min-w-[160px]">
            <label for="qa_preset" class="block text-xs font-semibold text-gray-600 mb-1">Preset</label>
            <select id="qa_preset"
              class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all">
            </select>
          </div>
          <button id="btnQuickAdd"
            class="w-full md:w-auto inline-flex items-center justify-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-all font-medium">
            <i data-lucide="plus" class="w-4 h-4"></i>
            Quick Add
          </button>
        </div>

        <div class="mt-3 grid grid-cols-1 md:grid-cols-5 gap-3">
          <div class="md:col-span-2">
            <label for="preset_name" class="block text-xs font-semibold text-gray-600 mb-1">New Preset Name</label>
            <input id="preset_name" type="text" placeholder="Weekly meeting"
              class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all" />
          </div>
          <div>
            <label for="preset_duration" class="block text-xs font-semibold text-gray-600 mb-1">Duration (min)</label>
            <input id="preset_duration" type="number" min="0" step="5" value="60"
              class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all" />
          </div>
          <div>
            <label for="preset_reminder" class="block text-xs font-semibold text-gray-600 mb-1">Reminder</label>
            <select id="preset_reminder"
              class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all">
              <option value="none">None</option>
              <option value="0">At time of event</option>
              <option value="5">5 minutes</option>
              <option value="15" selected>15 minutes</option>
              <option value="30">30 minutes</option>
              <option value="60">1 hour</option>
              <option value="120">2 hours</option>
              <option value="1440">1 day</option>
              <option value="2880">2 days</option>
              <option value="10080">1 week</option>
            </select>
          </div>
          <div>
            <label for="preset_showAs" class="block text-xs font-semibold text-gray-600 mb-1">Show As</label>
            <select id="preset_showAs"
              class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all">
              <option value="BUSY">Busy</option>
              <option value="FREE">Free</option>
              <option value="TENTATIVE">Tentative</option>
              <option value="OOF">Out of Office</option>
            </select>
          </div>
          <button id="btnSavePreset"
            class="w-full md:w-auto inline-flex items-center justify-center gap-2 bg-white border-2 border-indigo-200 text-indigo-700 px-4 py-2 rounded-lg hover:bg-indigo-50 transition-all font-medium">
            <i data-lucide="bookmark" class="w-4 h-4"></i>
            Save Preset
          </button>
        </div>
      </div>

      <!-- Bulk Edit -->
      <div id="bulkEditPanel" class="hidden bg-white border border-gray-200 rounded-xl p-4 mb-4">
        <div class="flex items-center justify-between gap-3 mb-3">
          <div class="text-sm font-semibold text-gray-700">Bulk Edit Selected</div>
          <div id="bulkEditCount" class="text-xs text-gray-500">0 selected</div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-6 gap-3">
          <div>
            <label for="bulk_date" class="block text-xs font-semibold text-gray-600 mb-1">Date</label>
            <input id="bulk_date" type="date"
              class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all" />
          </div>
          <div>
            <label for="bulk_startTime" class="block text-xs font-semibold text-gray-600 mb-1">Start Time</label>
            <input id="bulk_startTime" type="time"
              class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all" />
          </div>
          <div>
            <label for="bulk_endTime" class="block text-xs font-semibold text-gray-600 mb-1">End Time</label>
            <input id="bulk_endTime" type="time"
              class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all" />
          </div>
          <div>
            <label for="bulk_reminder" class="block text-xs font-semibold text-gray-600 mb-1">Reminder</label>
            <select id="bulk_reminder"
              class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all">
              <option value="">No change</option>
              <option value="none">None</option>
              <option value="0">At time of event</option>
              <option value="5">5 minutes</option>
              <option value="15">15 minutes</option>
              <option value="30">30 minutes</option>
              <option value="60">1 hour</option>
              <option value="120">2 hours</option>
              <option value="1440">1 day</option>
              <option value="2880">2 days</option>
              <option value="10080">1 week</option>
            </select>
          </div>
          <div>
            <label for="bulk_showAs" class="block text-xs font-semibold text-gray-600 mb-1">Show As</label>
            <select id="bulk_showAs"
              class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all">
              <option value="">No change</option>
              <option value="BUSY">Busy</option>
              <option value="FREE">Free</option>
              <option value="TENTATIVE">Tentative</option>
              <option value="OOF">Out of Office</option>
            </select>
          </div>
          <div class="flex items-end gap-2">
            <label class="flex items-center gap-2 text-xs font-semibold text-gray-600">
              <input id="bulk_allDay" type="checkbox" class="w-4 h-4 text-indigo-600 rounded" />
              All day
            </label>
          </div>
          <button id="btnApplyBulk"
            class="w-full md:w-auto inline-flex items-center justify-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-all font-medium">
            Apply to Selected
          </button>
        </div>
      </div>

      <!-- CSV Import -->
      <div id="csvPanel" class="hidden bg-white border border-gray-200 rounded-xl p-4 mb-4">
        <div class="text-sm font-semibold text-gray-700 mb-2">Import CSV</div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div class="md:col-span-1">
            <label for="csv_file" class="block text-xs font-semibold text-gray-600 mb-1">Upload CSV</label>
            <input id="csv_file" type="file" accept=".csv,text/csv"
              class="w-full text-sm text-gray-700" />
          </div>
          <div class="md:col-span-2">
            <label for="csv_text" class="block text-xs font-semibold text-gray-600 mb-1">Or paste CSV</label>
            <textarea id="csv_text" rows="3" placeholder="title,startDate,startTime,endDate,endTime,location,description,allDay,reminder,showAs,priority"
              class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all"></textarea>
          </div>
        </div>
        <div class="flex items-center gap-2 mt-3">
          <button id="btnImportCsv" type="button"
            class="inline-flex items-center justify-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-all font-medium">
            <i data-lucide="upload" class="w-4 h-4"></i>
            Import
          </button>
          <button id="btnDownloadCsvTemplate" type="button"
            class="inline-flex items-center justify-center gap-2 bg-white border-2 border-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 transition-all font-medium">
            <i data-lucide="download" class="w-4 h-4"></i>
            Download Template
          </button>
          <div class="text-xs text-gray-500">Headers supported: title,startDate,startTime,endDate,endTime,location,description,allDay,reminder,showAs,priority</div>
        </div>
        <div id="csvProgressWrap" class="hidden mt-3">
          <div class="flex items-center justify-between text-xs text-gray-500 mb-1">
            <span id="csvProgressLabel">Importing‚Ä¶</span>
            <span id="csvProgressPercent">0%</span>
          </div>
          <div class="h-2 w-full rounded-full bg-gray-100 overflow-hidden border border-gray-200">
            <div id="csvProgressBar" class="h-full w-0 bg-green-500 transition-all"></div>
          </div>
        </div>
      </div>

      <!-- Cards Grid -->
      <div id="cardsGrid" class="grid gap-4" style="grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));"></div>

      <!-- Compact List -->
      <div id="listWrap" class="hidden overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="text-left text-gray-500">
            <tr class="border-b border-gray-200">
              <th class="py-2 pr-2 w-10">
                <button id="listToggleAll" class="text-indigo-600 hover:text-indigo-800" title="Select All">
                  <i data-lucide="square" class="w-4 h-4"></i>
                </button>
              </th>
              <th class="py-2 pr-2 min-w-[180px]">Title</th>
              <th class="py-2 pr-2 min-w-[120px]">Date</th>
              <th class="py-2 pr-2 min-w-[100px]">Time</th>
              <th class="py-2 pr-2 min-w-[160px] hidden sm:table-cell">Location</th>
              <th class="py-2 pr-2 min-w-[110px]">Show As</th>
              <th class="py-2 pr-2 min-w-[90px] hidden md:table-cell">Reminder</th>
              <th class="py-2 pr-2 min-w-[90px] hidden md:table-cell">Priority</th>
              <th class="py-2 pl-2 min-w-[120px]">Actions</th>
            </tr>
          </thead>
          <tbody id="listBody" class="align-top"></tbody>
        </table>
      </div>

      <!-- Calendar View -->
      <div id="calendarWrap" class="hidden">
        <div id="calendar"></div>
      </div>
    </div>
  </div>

  <!-- Modal (Wizard) -->
  <div id="modalBackdrop" class="fixed inset-0 bg-black/50 items-center justify-center p-0 sm:p-4 z-50 hidden">
    <div class="bg-white sm:rounded-2xl sm:shadow-2xl w-full sm:max-w-3xl sm:h-[90vh] h-full flex flex-col"
         role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-describedby="modalDesc">
      <!-- Header -->
      <div class="bg-white border-b border-gray-200 p-4 sm:p-6">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="bg-gradient-to-br from-indigo-500 to-purple-600 p-2 rounded-lg">
              <i data-lucide="edit-3" class="w-5 h-5 text-white"></i>
            </div>
            <div>
              <h3 id="modalTitle" class="text-xl sm:text-2xl font-bold text-gray-800">Create New Event</h3>
              <p id="modalDesc" class="text-sm text-gray-500">Fill in the event details</p>
            </div>
          </div>
          <button id="btnCloseModal"
            class="text-gray-400 hover:text-gray-600 p-2 hover:bg-gray-100 rounded-lg transition-colors"
            aria-label="Close">
            <i data-lucide="x" class="w-6 h-6"></i>
          </button>
        </div>
      </div>

      <!-- Body -->
      <div class="overflow-y-auto flex-1 p-4 sm:p-6 modal-body">
        <div class="space-y-6">
          <!-- Title -->
          <div>
            <label for="f_title" class="block text-sm font-semibold text-gray-700 mb-2">Event Title *</label>
            <input id="f_title" type="text" placeholder="Team Meeting, Conference Call, etc."
              class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all" />
          </div>

          <!-- All day -->
          <div class="bg-gray-50 p-4 rounded-xl">
            <label class="flex items-center gap-3 cursor-pointer">
              <input id="f_allDay" type="checkbox"
                class="w-5 h-5 text-indigo-600 rounded focus:ring-2 focus:ring-indigo-500" />
              <span class="text-sm font-semibold text-gray-700">All day event</span>
            </label>
          </div>

          <!-- Dates / Times -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="f_startDate" class="block text-sm font-semibold text-gray-700 mb-2">Start Date *</label>
              <input id="f_startDate" type="date"
                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all" />
            </div>

            <div id="startTimeBlock">
              <label class="block text-sm font-semibold text-gray-700 mb-2">Start Time *</label>
              <div class="grid grid-cols-3 gap-2">
                <select id="f_startHour"
                  class="px-3 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all"></select>
                <select id="f_startMinute"
                  class="px-3 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all">
                  <option>00</option><option>15</option><option>30</option><option>45</option>
                </select>
                <select id="f_startPeriod"
                  class="px-3 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all">
                  <option>AM</option><option>PM</option>
                </select>
              </div>
            </div>

            <div>
              <label for="f_endDate" class="block text-sm font-semibold text-gray-700 mb-2">End Date</label>
              <input id="f_endDate" type="date"
                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all" />
            </div>

            <div id="endTimeBlock">
              <label class="block text-sm font-semibold text-gray-700 mb-2">End Time</label>
              <div class="grid grid-cols-3 gap-2">
                <select id="f_endHour"
                  class="px-3 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all"></select>
                <select id="f_endMinute"
                  class="px-3 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all">
                  <option>00</option><option>15</option><option>30</option><option>45</option>
                </select>
                <select id="f_endPeriod"
                  class="px-3 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all">
                  <option>AM</option><option>PM</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Location -->
          <div>
            <label for="f_location" class="block text-sm font-semibold text-gray-700 mb-2">Location</label>
            <input id="f_location" type="text" placeholder="Conference Room A, Zoom, or address"
              class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all" />
          </div>

          <!-- Show As / Priority / Reminder -->
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
            <div>
              <label for="f_showAs" class="block text-sm font-semibold text-gray-700 mb-2">Show As</label>
              <select id="f_showAs"
                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all">
                <option value="BUSY">Busy</option>
                <option value="FREE">Free</option>
                <option value="TENTATIVE">Tentative</option>
                <option value="OOF">Out of Office</option>
              </select>
            </div>
            <div>
              <label for="f_priority" class="block text-sm font-semibold text-gray-700 mb-2">Priority</label>
              <select id="f_priority"
                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all">
                <option value="HIGH">High</option>
                <option value="NORMAL" selected>Normal</option>
                <option value="LOW">Low</option>
              </select>
            </div>
            <div>
              <label for="f_reminder" class="block text-sm font-semibold text-gray-700 mb-2">Reminder</label>
              <select id="f_reminder"
                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all">
                <option value="none">None</option>
                <option value="0">At time of event</option>
                <option value="5">5 minutes</option>
                <option value="15" selected>15 minutes</option>
                <option value="30">30 minutes</option>
                <option value="60">1 hour</option>
                <option value="120">2 hours</option>
                <option value="1440">1 day</option>
                <option value="2880">2 days</option>
                <option value="10080">1 week</option>
              </select>
            </div>
          </div>

          <!-- Description -->
          <div>
            <label for="f_description" class="block text-sm font-semibold text-gray-700 mb-2">Description / Notes</label>
            <textarea id="f_description" rows="5" placeholder="Add meeting agenda, notes, or additional details..."
              class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all"></textarea>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="bg-white border-t border-gray-200 p-4 sm:p-6">
        <div class="flex flex-col sm:flex-row gap-3">
          <button id="btnSaveEvent"
            class="w-full sm:flex-1 inline-flex items-center justify-center gap-2 bg-gradient-to-r from-indigo-600 to-indigo-700 text-white px-6 py-3 rounded-xl hover:from-indigo-700 hover:to-indigo-800 transition-all shadow-md hover:shadow-lg font-semibold">
            <i data-lucide="save" class="w-5 h-5"></i>
            Save Event
          </button>
          <button id="btnCancelEvent"
            class="w-full sm:w-auto px-6 py-3 rounded-xl border-2 border-gray-300 text-gray-700 hover:bg-gray-50 transition-all font-semibold">
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ------------------------------
    // State & utilities (parity with your TSX)
    // ------------------------------
    const state = {
      events: [],
      editingId: null,
      selectedIds: new Set(),
      showWizard: false,
      showCsvPanel: false,
      view: 'cards', // 'cards' | 'list' | 'calendar'
      presets: []
    };

    const qs = (sel, el = document) => el.querySelector(sel);
    function nanoid() { return Date.now() + Math.floor(Math.random() * 1e6); }

    function convertTo24Hour(hour, minute, period) {
      let h = parseInt(hour, 10);
      if (period === 'PM' && h !== 12) h += 12;
      if (period === 'AM' && h === 12) h = 0;
      return `${h.toString().padStart(2, '0')}:${minute}`;
    }
    function convertTo12Hour(time24) {
      if (!time24) return { hour: '12', minute: '00', period: 'AM' };
      const [h, m] = time24.split(':');
      let hour = parseInt(h, 10);
      const period = hour >= 12 ? 'PM' : 'AM';
      if (hour === 0) hour = 12; else if (hour > 12) hour -= 12;
      return { hour: String(hour), minute: m, period };
    }
    function formatDateTime(date, time, isAllDay) {
      if (isAllDay) return date.replace(/-/g, '');
      const datetime = `${date}T${time}:00`;
      return datetime.replace(/[-:]/g, '');
    }
    function getPriorityNumber(p) { return p === 'HIGH' ? '1' : p === 'LOW' ? '9' : '5'; }
    function validEvent(e) { return !!(e.title && e.startDate && (e.isAllDay || e.startTime)); }
    function formatDateDisplay(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr + 'T00:00:00');
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }
    function getStatusBadgeColor(showAs) {
      switch (showAs) {
        case 'BUSY': return 'bg-red-100 text-red-700';
        case 'FREE': return 'bg-green-100 text-green-700';
        case 'TENTATIVE': return 'bg-yellow-100 text-yellow-700';
        case 'OOF': return 'bg-purple-100 text-purple-700';
        default: return 'bg-gray-100 text-gray-700';
      }
    }
    function formatTimeLabel(ev) {
      if (ev.isAllDay) return 'All day';
      if (!ev.startTime) return 'No time';
      const { hour, minute, period } = convertTo12Hour(ev.startTime);
      return `${hour}:${minute} ${period}`;
    }
    function formatReminderLabel(rem) {
      if (!rem || rem === 'none') return 'None';
      const n = parseInt(rem, 10);
      if (n < 60) return `${n} min`;
      if (n % 1440 === 0) return `${n / 1440} day${n === 1440 ? '' : 's'}`;
      if (n % 60 === 0) return `${n / 60} hr`;
      return `${n} min`;
    }
    function addMinutesToTime(time24, minutesToAdd) {
      if (!time24) return '';
      const [h, m] = time24.split(':').map(v => parseInt(v, 10));
      const total = (h * 60 + m + minutesToAdd) % (24 * 60);
      const hh = Math.floor(total / 60).toString().padStart(2, '0');
      const mm = (total % 60).toString().padStart(2, '0');
      return `${hh}:${mm}`;
    }
    function parseCsv(text) {
      const rows = [];
      let row = [];
      let current = '';
      let inQuotes = false;
      for (let i = 0; i < text.length; i++) {
        const c = text[i];
        if (c === '"') {
          if (inQuotes && text[i + 1] === '"') {
            current += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (c === ',' && !inQuotes) {
          row.push(current.trim());
          current = '';
        } else if ((c === '\n' || c === '\r') && !inQuotes) {
          if (current.length || row.length) {
            row.push(current.trim());
            rows.push(row);
            row = [];
            current = '';
          }
        } else {
          current += c;
        }
      }
      if (current.length || row.length) {
        row.push(current.trim());
        rows.push(row);
      }
      return rows.filter(r => r.some(cell => cell !== ''));
    }
    function loadPresets() {
      try {
        const raw = localStorage.getItem('ical_presets');
        if (raw) state.presets = JSON.parse(raw);
      } catch (e) {
        state.presets = [];
      }
      if (!state.presets.length) {
        state.presets = [
          { id: 'default', name: 'Default', duration: 60, reminder: '15', showAs: 'BUSY' }
        ];
      }
    }
    function savePresets() {
      localStorage.setItem('ical_presets', JSON.stringify(state.presets));
    }

    // Map our events to FullCalendar event objects
    function toCalendarEvents() {
      return state.events.map(ev => {
        const allDay = !!ev.isAllDay;
        let startStr = ev.startDate;
        let endStr = ev.endDate || ev.startDate;

        if (allDay) {
          // FullCalendar expects all-day 'end' to be exclusive; add 1 day
          const d = new Date(endStr + 'T00:00:00');
          d.setDate(d.getDate() + 1);
          endStr = d.toISOString().slice(0, 10);
        } else {
          startStr += 'T' + (ev.startTime || '00:00');
          endStr   += 'T' + (ev.endTime   || ev.startTime || '00:00');
        }

        return {
          id: String(ev.id),
          title: ev.title || 'Untitled Event',
          start: startStr,
          end: endStr,
          allDay,
          extendedProps: {
            internalId: ev.id,
            location: ev.location,
            showAs: ev.showAs,
            priority: ev.priority,
            reminder: ev.reminder,
            description: ev.description
          }
        };
      });
    }

    // ------------------------------
    // DOM refs
    // ------------------------------
    const emptyState = qs('#emptyState');
    const eventsPanel = qs('#eventsPanel');
    const eventsCount = qs('#eventsCount');
    const cardsGrid = qs('#cardsGrid');
    const btnToggleAll = qs('#btnToggleAll');
    const toggleAllLabel = qs('#toggleAllLabel');
    const btnDeleteSelected = qs('#btnDeleteSelected');
    const deleteLabel = qs('#deleteLabel');
    const btnDownload = qs('#btnDownload');
    const downloadLabel = qs('#downloadLabel');
    const btnToggleCsv = qs('#btnToggleCsv');
    const csvPanel = qs('#csvPanel');
    const qaTitle = qs('#qa_title');
    const qaDate = qs('#qa_date');
    const qaTime = qs('#qa_time');
    const qaPreset = qs('#qa_preset');
    const btnQuickAdd = qs('#btnQuickAdd');
    const presetName = qs('#preset_name');
    const presetDuration = qs('#preset_duration');
    const presetReminder = qs('#preset_reminder');
    const presetShowAs = qs('#preset_showAs');
    const btnSavePreset = qs('#btnSavePreset');
    const bulkEditPanel = qs('#bulkEditPanel');
    const bulkEditCount = qs('#bulkEditCount');
    const bulkDate = qs('#bulk_date');
    const bulkStartTime = qs('#bulk_startTime');
    const bulkEndTime = qs('#bulk_endTime');
    const bulkReminder = qs('#bulk_reminder');
    const bulkShowAs = qs('#bulk_showAs');
    const bulkAllDay = qs('#bulk_allDay');
    const btnApplyBulk = qs('#btnApplyBulk');
    const csvFile = qs('#csv_file');
    const csvText = qs('#csv_text');
    const btnImportCsv = qs('#btnImportCsv');
    const btnDownloadCsvTemplate = qs('#btnDownloadCsvTemplate');
    const csvProgressWrap = qs('#csvProgressWrap');
    const csvProgressLabel = qs('#csvProgressLabel');
    const csvProgressPercent = qs('#csvProgressPercent');
    const csvProgressBar = qs('#csvProgressBar');

    const listWrap = qs('#listWrap');
    const listBody = qs('#listBody');
    const listToggleAllBtn = qs('#listToggleAll');

    const calendarWrap = qs('#calendarWrap');
    const calendarEl = qs('#calendar');

    // View toggles
    const viewCardsBtn = qs('#viewCards');
    const viewListBtn = qs('#viewList');
    const viewCalendarBtn = qs('#viewCalendar');

    // Modal refs
    const modalBackdrop = qs('#modalBackdrop');
    const modalTitle = qs('#modalTitle');
    const btnCloseModal = qs('#btnCloseModal');
    const btnCancelEvent = qs('#btnCancelEvent');
    const btnSaveEvent = qs('#btnSaveEvent');

    const f_title = qs('#f_title');
    const f_allDay = qs('#f_allDay');
    const f_startDate = qs('#f_startDate');
    const f_endDate = qs('#f_endDate');
    const startTimeBlock = qs('#startTimeBlock');
    const endTimeBlock = qs('#endTimeBlock');
    const f_startHour = qs('#f_startHour');
    const f_startMinute = qs('#f_startMinute');
    const f_startPeriod = qs('#f_startPeriod');
    const f_endHour = qs('#f_endHour');
    const f_endMinute = qs('#f_endMinute');
    const f_endPeriod = qs('#f_endPeriod');
    const f_location = qs('#f_location');
    const f_showAs = qs('#f_showAs');
    const f_priority = qs('#f_priority');
    const f_reminder = qs('#f_reminder');
    const f_description = qs('#f_description');
    let lastStartDateValue = '';

    // populate hours 1..12
    function populateHours(select) {
      select.innerHTML = '';
      for (let i = 1; i <= 12; i++) {
        const opt = document.createElement('option');
        opt.value = String(i);
        opt.textContent = String(i);
        select.appendChild(opt);
      }
    }
    populateHours(f_startHour);
    populateHours(f_endHour);

    // ------------------------------
    // Calendar setup
    // ------------------------------
    let fc = null;
    function ensureCalendar() {
      if (fc) return;
      fc = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        height: 'auto',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        // Click a date to add a new draft event and open the editor
        dateClick: (info) => {
          const newEvent = {
            id: nanoid(),
            title: '',
            startDate: info.dateStr,
            startTime: '',
            endDate: info.dateStr,
            endTime: '',
            location: '',
            description: '',
            isAllDay: true,
            reminder: '15',
            showAs: 'BUSY',
            priority: 'NORMAL',
            isNew: true
          };
          state.events.push(newEvent);
          openWizard(newEvent.id);
          render(); // refresh other views/counts
        },
        // Click an existing event to edit it
        eventClick: (arg) => {
          const internalId = arg.event.extendedProps.internalId;
          if (internalId != null) {
            openWizard(internalId);
          }
        },
        events: []
      });
      fc.render();
    }

    function refreshCalendarEvents() {
      if (!fc) return;
      fc.removeAllEvents();
      fc.addEventSource(toCalendarEvents());
    }

    // ------------------------------
    // Rendering
    // ------------------------------
    function render() {
      // Toggle empty/list panels
      if (state.events.length === 0 && !state.showCsvPanel) {
        emptyState.classList.remove('hidden');
        eventsPanel.classList.add('hidden');
      } else {
        emptyState.classList.add('hidden');
        eventsPanel.classList.remove('hidden');
      }

      eventsCount.textContent = state.events.length;

      // Selected count UI
      const selectedCount = state.selectedIds.size;
      if (selectedCount > 0) {
        btnDeleteSelected.style.display = '';
        deleteLabel.textContent = `Delete (${selectedCount})`;
        bulkEditPanel.classList.remove('hidden');
        bulkEditCount.textContent = `${selectedCount} selected`;
      } else {
        btnDeleteSelected.style.display = 'none';
        bulkEditPanel.classList.add('hidden');
        bulkEditCount.textContent = '0 selected';
      }

      // Download button enable/disable
      const validCount = state.events.filter(validEvent).length;
      btnDownload.disabled = validCount === 0;
      btnDownload.className = `w-full sm:w-auto inline-flex items-center justify-center gap-2 px-6 py-3 rounded-xl transition-all shadow-md font-medium ${
        validCount > 0
          ? 'bg-gradient-to-r from-green-600 to-emerald-600 text-white hover:from-green-700 hover:to-emerald-700 hover:shadow-lg'
          : 'bg-gray-200 text-gray-400 cursor-not-allowed'
      }`;
      downloadLabel.textContent = `Download (${validCount})`;

      // Toggle all label/icon (shared)
      const allSelected = state.events.length > 0 && selectedCount === state.events.length;
      toggleAllLabel.textContent = allSelected ? 'Deselect All' : 'Select All';
      const icon = btnToggleAll.querySelector('i');
      if (icon) icon.setAttribute('data-lucide', allSelected ? 'check-square' : 'square');

      // Clear Card & List containers each render
      cardsGrid.innerHTML = '';
      listBody.innerHTML  = '';

      // Preset select options
      qaPreset.innerHTML = '';
      state.presets.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = `${p.name} (${p.duration}m)`;
        qaPreset.appendChild(opt);
      });

      // Toggle view containers
      if (state.view === 'cards') {
        cardsGrid.classList.remove('hidden');
        listWrap.classList.add('hidden');
        calendarWrap.classList.add('hidden');

        state.events.forEach(ev => {
          const isSelected = state.selectedIds.has(ev.id);
          const summaryDate = ev.startDate || 'No date';
          const time = formatTimeLabel(ev);
          const title = ev.title || 'Untitled Event';

          const card = document.createElement('div');
          card.className = `p-4 rounded-xl transition-all border-2 h-full flex ${
            isSelected ? 'border-indigo-300 bg-indigo-50 shadow-md' : 'border-gray-200 hover:border-indigo-300 bg-white hover:shadow-md'
          }`;

          card.innerHTML = `
            <div class="flex items-start gap-3 w-full">
              <button data-action="toggle-select"
                class="mt-1 text-gray-400 hover:text-indigo-600 transition-colors" aria-label="Toggle select">
                <i data-lucide="${isSelected ? 'check-square' : 'square'}" class="w-5 h-5 ${isSelected ? 'text-indigo-600' : ''}"></i>
              </button>

              <div class="flex-1 min-w-0">
                <div class="flex items-start justify-between gap-2 mb-2">
                  <h4 class="font-semibold text-gray-900 truncate">${title}</h4>
                </div>

                <div class="space-y-1 text-sm">
                  <div class="flex items-center gap-2 text-gray-600">
                    <i data-lucide="clock" class="w-4 h-4 flex-shrink-0"></i>
                    <span class="truncate">${formatDateDisplay(summaryDate)} ‚Ä¢ ${time}</span>
                  </div>
                  ${ev.location ? `<div class="text-gray-500 truncate">üìç ${ev.location}</div>` : ''}
                </div>

                <div class="mt-3 flex flex-wrap gap-2">
                  <span class="text-xs px-2 py-1 rounded-full font-medium ${getStatusBadgeColor(ev.showAs)}">${ev.showAs}</span>
                </div>

                <div class="mt-3 flex flex-col sm:flex-row gap-2">
                  <button data-action="edit"
                    class="flex-1 text-xs bg-indigo-100 text-indigo-700 px-3 py-1.5 rounded-lg hover:bg-indigo-200 transition-colors font-medium">
                    Edit
                  </button>
                  <button data-action="duplicate"
                    class="text-xs bg-gray-100 text-gray-700 px-3 py-1.5 rounded-lg hover:bg-gray-200 transition-colors font-medium">
                    Duplicate
                  </button>
                  <button data-action="delete"
                    class="text-xs text-red-600 hover:text-red-800 px-3 py-1.5 rounded-lg hover:bg-red-50 transition-colors font-medium">
                    Delete
                  </button>
                </div>
              </div>
            </div>
          `;

          // handlers
          card.querySelector('[data-action="toggle-select"]').addEventListener('click', (e) => {
            e.stopPropagation();
            if (state.selectedIds.has(ev.id)) state.selectedIds.delete(ev.id); else state.selectedIds.add(ev.id);
            render();
          });
          card.querySelector('[data-action="edit"]').addEventListener('click', () => openWizard(ev.id));
          card.querySelector('[data-action="duplicate"]').addEventListener('click', () => duplicateEvent(ev.id));
          card.querySelector('[data-action="delete"]').addEventListener('click', (e) => { e.stopPropagation(); removeEvent(ev.id); });

          cardsGrid.appendChild(card);
        });

      } else if (state.view === 'list') {
        cardsGrid.classList.add('hidden');
        listWrap.classList.remove('hidden');
        calendarWrap.classList.add('hidden');

        state.events.forEach(ev => {
          const isSelected = state.selectedIds.has(ev.id);
          const title = ev.title || 'Untitled Event';
          const dateLabel = ev.startDate ? formatDateDisplay(ev.startDate) : '‚Äî';
          const timeLabel = formatTimeLabel(ev);
          const reminderLabel = formatReminderLabel(ev.reminder);
          const prio = (ev.priority || 'NORMAL').toUpperCase();

          const tr = document.createElement('tr');
          tr.className = 'border-b border-gray-100 hover:bg-indigo-50/30';

          tr.innerHTML = `
            <td class="py-2 pr-2 align-top">
              <button data-action="toggle-select" class="text-indigo-600 hover:text-indigo-800" title="Toggle select">
                <i data-lucide="${isSelected ? 'check-square' : 'square'}" class="w-4 h-4 ${isSelected ? 'text-indigo-600' : ''}"></i>
              </button>
            </td>
            <td class="py-2 pr-2 align-top">
              <div class="font-medium text-gray-900 truncate max-w-[260px]">${title}</div>
              ${ev.description ? `<div class="text-gray-500 truncate max-w-[340px]">${ev.description}</div>` : ''}
            </td>
            <td class="py-2 pr-2 align-top text-gray-700">${dateLabel}</td>
            <td class="py-2 pr-2 align-top text-gray-700">${timeLabel}</td>
            <td class="py-2 pr-2 align-top text-gray-600 hidden sm:table-cell truncate max-w-[220px]">${ev.location || '‚Äî'}</td>
            <td class="py-2 pr-2 align-top">
              <span class="text-xs px-2 py-1 rounded-full font-medium ${getStatusBadgeColor(ev.showAs)}">${ev.showAs}</span>
            </td>
            <td class="py-2 pr-2 align-top text-gray-700 hidden md:table-cell">${reminderLabel}</td>
            <td class="py-2 pr-2 align-top text-gray-700 hidden md:table-cell">${prio}</td>
            <td class="py-2 pl-2 align-top">
              <div class="inline-flex gap-1">
                <button data-action="edit"
                  class="text-xs bg-indigo-100 text-indigo-700 px-3 py-1.5 rounded-lg hover:bg-indigo-200 transition-colors font-medium">
                  Edit
                </button>
                <button data-action="duplicate"
                  class="text-xs bg-gray-100 text-gray-700 px-3 py-1.5 rounded-lg hover:bg-gray-200 transition-colors font-medium">
                  Duplicate
                </button>
                <button data-action="delete"
                  class="text-xs text-red-600 hover:text-red-800 px-3 py-1.5 rounded-lg hover:bg-red-50 transition-colors font-medium">
                  Delete
                </button>
              </div>
            </td>
          `;

          tr.querySelector('[data-action="toggle-select"]').addEventListener('click', () => {
            if (state.selectedIds.has(ev.id)) state.selectedIds.delete(ev.id); else state.selectedIds.add(ev.id);
            render();
          });
          tr.querySelector('[data-action="edit"]').addEventListener('click', () => openWizard(ev.id));
          tr.querySelector('[data-action="duplicate"]').addEventListener('click', () => duplicateEvent(ev.id));
          tr.querySelector('[data-action="delete"]').addEventListener('click', () => removeEvent(ev.id));

          listBody.appendChild(tr);
        });

      } else {
        // CALENDAR view
        cardsGrid.classList.add('hidden');
        listWrap.classList.add('hidden');
        calendarWrap.classList.remove('hidden');

        ensureCalendar();
        refreshCalendarEvents();
      }

      // Refresh icons
      if (window.lucide && typeof lucide.createIcons === 'function') {
        lucide.createIcons();
      }
    }

    // ------------------------------
    // CRUD & selection
    // ------------------------------
    function addEvent() {
      const newEvent = {
        id: nanoid(),
        title: '',
        startDate: '',
        startTime: '',
        endDate: '',
        endTime: '',
        location: '',
        description: '',
        isAllDay: false,
        reminder: '15',
        showAs: 'BUSY',
        priority: 'NORMAL',
        isNew: true
      };
      state.events.push(newEvent);
      state.editingId = newEvent.id;
      openWizard(newEvent.id);
      render();
    }

    function removeEvent(id) {
      state.events = state.events.filter(e => e.id !== id);
      state.selectedIds.delete(id);
      if (state.editingId === id && state.events.length) state.editingId = state.events[0].id;
      render();
    }

    function duplicateEvent(id) {
      const ev = state.events.find(e => e.id === id);
      if (!ev) return;
      const copy = {
        ...ev,
        id: nanoid(),
        title: ev.title ? `${ev.title} (Copy)` : 'Untitled Event',
        isNew: false
      };
      state.events.push(copy);
      openWizard(copy.id);
      render();
    }

    function deleteSelected() {
      if (state.selectedIds.size === 0) return;
      state.events = state.events.filter(e => !state.selectedIds.has(e.id));
      state.selectedIds.clear();
      render();
    }

    function toggleSelectAll() {
      if (state.selectedIds.size === state.events.length) state.selectedIds.clear();
      else state.selectedIds = new Set(state.events.map(e => e.id));
      render();
    }

    function applyBulkEdit() {
      if (state.selectedIds.size === 0) return;
      const dateVal = bulkDate.value;
      const startVal = bulkStartTime.value;
      const endVal = bulkEndTime.value;
      const reminderVal = bulkReminder.value;
      const showAsVal = bulkShowAs.value;
      const allDayVal = bulkAllDay.checked;

      state.events = state.events.map(ev => {
        if (!state.selectedIds.has(ev.id)) return ev;
        const updated = { ...ev };
        if (dateVal) {
          updated.startDate = dateVal;
          updated.endDate = dateVal;
        }
        if (allDayVal) {
          updated.isAllDay = true;
          updated.startTime = '';
          updated.endTime = '';
        } else {
          if (startVal) {
            updated.isAllDay = false;
            updated.startTime = startVal;
          }
          if (endVal) {
            updated.isAllDay = false;
            updated.endTime = endVal;
          }
        }
        if (reminderVal !== '') updated.reminder = reminderVal;
        if (showAsVal !== '') updated.showAs = showAsVal;
        return updated;
      });
      render();
    }

    function quickAddEvent() {
      const title = qaTitle.value.trim();
      const date = qaDate.value;
      const time = qaTime.value;
      if (!title || !date || !time) {
        alert('Quick Add requires title, date, and time.');
        return;
      }
      const presetId = qaPreset.value;
      const preset = state.presets.find(p => p.id === presetId) || state.presets[0];
      const duration = preset ? parseInt(preset.duration, 10) || 0 : 0;
      const endTime = duration ? addMinutesToTime(time, duration) : time;

      const newEvent = {
        id: nanoid(),
        title,
        startDate: date,
        startTime: time,
        endDate: date,
        endTime,
        location: '',
        description: '',
        isAllDay: false,
        reminder: preset ? preset.reminder : '15',
        showAs: preset ? preset.showAs : 'BUSY',
        priority: 'NORMAL',
        isNew: false
      };
      state.events.push(newEvent);
      qaTitle.value = '';
      render();
    }

    function savePresetFromForm() {
      const name = presetName.value.trim();
      if (!name) {
        alert('Preset name is required.');
        return;
      }
      const duration = parseInt(presetDuration.value, 10);
      const preset = {
        id: nanoid(),
        name,
        duration: Number.isFinite(duration) ? duration : 60,
        reminder: presetReminder.value,
        showAs: presetShowAs.value
      };
      state.presets.push(preset);
      savePresets();
      presetName.value = '';
      render();
    }

    function importCsvText(text) {
      const rows = parseCsv(text);
      if (!rows.length) return;
      const header = rows[0].map(h => h.toLowerCase());
      const hasHeader = header.includes('title') || header.includes('startdate');
      const dataRows = hasHeader ? rows.slice(1) : rows;
      const idx = (name) => header.indexOf(name);

      dataRows.forEach(r => {
        if (!r.length) return;
        const get = (name, fallbackIdx) => {
          if (hasHeader) {
            const i = idx(name);
            return i >= 0 ? r[i] : '';
          }
          return r[fallbackIdx] || '';
        };

        const title = get('title', 0).trim();
        const startDate = get('startdate', 1).trim();
        const startTime = get('starttime', 2).trim();
        const endDate = get('enddate', 3).trim() || startDate;
        const endTime = get('endtime', 4).trim() || startTime;
        const location = get('location', 5).trim();
        const description = get('description', 6).trim();
        const allDayRaw = get('allday', 7).trim().toLowerCase();
        const reminder = get('reminder', 8).trim() || '15';
        const showAs = (get('showas', 9).trim() || 'BUSY').toUpperCase();
        const priority = (get('priority', 10).trim() || 'NORMAL').toUpperCase();
        const isAllDay = allDayRaw === 'true' || allDayRaw === '1' || allDayRaw === 'yes';

        if (!title || !startDate) return;
        state.events.push({
          id: nanoid(),
          title,
          startDate,
          startTime: isAllDay ? '' : startTime,
          endDate,
          endTime: isAllDay ? '' : endTime,
          location,
          description,
          isAllDay,
          reminder,
          showAs,
          priority,
          isNew: false
        });
      });
      render();
    }

    function setCsvProgress(percent, label = 'Importing‚Ä¶') {
      csvProgressWrap.classList.remove('hidden');
      csvProgressLabel.textContent = label;
      if (percent == null) {
        csvProgressPercent.textContent = '';
        csvProgressBar.classList.add('animate-pulse');
        csvProgressBar.style.width = '100%';
        return;
      }
      const clamped = Math.max(0, Math.min(100, Math.round(percent)));
      csvProgressPercent.textContent = `${clamped}%`;
      csvProgressBar.classList.remove('animate-pulse');
      csvProgressBar.style.width = `${clamped}%`;
    }

    function resetCsvProgress() {
      csvProgressBar.classList.remove('animate-pulse');
      csvProgressBar.style.width = '0%';
      csvProgressPercent.textContent = '0%';
      csvProgressWrap.classList.add('hidden');
    }

    function downloadCsvTemplate() {
      const header = [
        'title',
        'startDate',
        'startTime',
        'endDate',
        'endTime',
        'location',
        'description',
        'allDay',
        'reminder',
        'showAs',
        'priority'
      ].join(',');
      const example = [
        'Example Meeting',
        '2026-03-15',
        '09:00',
        '2026-03-15',
        '10:00',
        'Conference Room A',
        'Weekly sync',
        'false',
        '15',
        'BUSY',
        'NORMAL'
      ].join(',');
      const content = `${header}\n${example}\n`;
      const blob = new Blob([content], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'bulk-events-template.csv';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // ------------------------------
    // Wizard (modal)
    // ------------------------------
    function openWizard(id) {
      const ev = state.events.find(e => e.id === id);
      if (!ev) return;
      state.editingId = id;
      state.showWizard = true;

      modalTitle.textContent = ev.isNew ? 'Create New Event' : 'Edit Event';
      f_title.value = ev.title || '';
      f_allDay.checked = !!ev.isAllDay;
      f_startDate.value = ev.startDate || '';
      f_endDate.value = ev.endDate || '';
      if (f_startDate.value && !f_endDate.value) {
        f_endDate.value = f_startDate.value;
      }
      f_location.value = ev.location || '';
      f_showAs.value = ev.showAs || 'BUSY';
      f_priority.value = ev.priority || 'NORMAL';
      f_reminder.value = ev.reminder ?? '15';
      f_description.value = ev.description || '';

      const s = convertTo12Hour(ev.startTime || '');
      f_startHour.value = s.hour;
      f_startMinute.value = s.minute;
      f_startPeriod.value = s.period;

      const e12 = convertTo12Hour(ev.endTime || '');
      f_endHour.value = e12.hour;
      f_endMinute.value = e12.minute;
      f_endPeriod.value = e12.period;

      toggleAllDayUI();
      lastStartDateValue = f_startDate.value || '';

      // Show modal: remove 'hidden' and add 'flex' so centering works
      modalBackdrop.classList.remove('hidden');
      modalBackdrop.classList.add('flex');

      f_title.focus();
      if (window.lucide && typeof lucide.createIcons === 'function') lucide.createIcons();
    }

    function closeWizardInternal() {
      const ev = state.events.find(e => e.id === state.editingId);
      // Discard new untitled event on close
      if (ev && ev.isNew && !ev.title) {
        state.events = state.events.filter(e => e.id !== state.editingId);
      }
      state.showWizard = false;
      state.editingId = null;

      // Hide modal: add 'hidden' and remove 'flex'
      modalBackdrop.classList.add('hidden');
      modalBackdrop.classList.remove('flex');

      render();
    }

    function saveEvent() {
      const id = state.editingId;
      const idx = state.events.findIndex(e => e.id === id);
      if (idx === -1) return;

      const isAllDay = f_allDay.checked;
      let startTime = '', endTime = '';
      if (!isAllDay) {
        startTime = convertTo24Hour(f_startHour.value, f_startMinute.value, f_startPeriod.value);
        endTime = convertTo24Hour(f_endHour.value, f_endMinute.value, f_endPeriod.value);
      }

      const updated = {
        ...state.events[idx],
        title: f_title.value.trim(),
        isAllDay,
        startDate: f_startDate.value,
        startTime,
        endDate: f_endDate.value,
        endTime,
        location: f_location.value.trim(),
        showAs: f_showAs.value,
        priority: f_priority.value,
        reminder: f_reminder.value,
        description: f_description.value,
        isNew: false
      };

      if (updated.startDate && !updated.endDate) updated.endDate = updated.startDate;

      state.events.splice(idx, 1, updated);
      closeWizardInternal();
      refreshCalendarEvents(); // keep calendar in sync immediately on save
    }

    function toggleAllDayUI() {
      const allDay = f_allDay.checked;
      startTimeBlock.style.display = allDay ? 'none' : '';
      endTimeBlock.style.display = allDay ? 'none' : '';
    }

    // ------------------------------
    // Bulk download ICS
    // ------------------------------
    function generateICalEvent(event) {
      const now = new Date().toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
      const uid = `${event.id}-${now}@bulk-ical-generator`;

      let startDateTime, endDateTime;
      if (event.isAllDay) {
        startDateTime = formatDateTime(event.startDate, '', true);
        endDateTime = formatDateTime(event.endDate || event.startDate, '', true);
      } else {
        startDateTime = formatDateTime(event.startDate, event.startTime, false);
        endDateTime = formatDateTime(event.endDate || event.startDate, event.endTime || event.startTime, false);
      }

      let ical = `BEGIN:VEVENT
UID:${uid}
DTSTAMP:${now}`;

      if (event.isAllDay) {
        ical += `
DTSTART;VALUE=DATE:${startDateTime}
DTEND;VALUE=DATE:${endDateTime}`;
      } else {
        ical += `
DTSTART:${startDateTime}
DTEND:${endDateTime}`;
      }

      const title = event.title || 'Untitled Event';
      ical += `
SUMMARY:${title}`;

      if (event.location) ical += `\nLOCATION:${event.location}`;
      if (event.description) {
        const escaped = event.description.replace(/\n/g, '\\n').replace(/,/g, '\\,');
        ical += `\nDESCRIPTION:${escaped}`;
      }

      ical += `
STATUS:CONFIRMED
TRANSP:${event.showAs === 'FREE' ? 'TRANSPARENT' : 'OPAQUE'}
X-MICROSOFT-CDO-BUSYSTATUS:${event.showAs}
PRIORITY:${getPriorityNumber(event.priority)}`;

      if (event.reminder && event.reminder !== 'none') {
        ical += `
BEGIN:VALARM
TRIGGER:-PT${event.reminder}M
ACTION:DISPLAY
DESCRIPTION:Reminder
END:VALARM`;
      }

      ical += `
END:VEVENT`;
      return ical;
    }

    function downloadICalFile() {
      const validEvents = state.events.filter(validEvent);
      if (validEvents.length === 0) {
        alert('Please add at least one event with a title, date, and time.');
        return;
      }
      const icalEvents = validEvents.map(generateICalEvent).join('\n');
      const icalContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Bulk iCal Generator//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
X-WR-CALNAME:Bulk Events
X-WR-TIMEZONE:UTC
X-MICROSOFT-CALSCALE:GREGORIAN
${icalEvents}
END:VCALENDAR`;

      const blob = new Blob([icalContent], { type: 'text/calendar;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'bulk-events.ics';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    // ------------------------------
    // Wire up events
    // ------------------------------
    const btnAdd = document.getElementById('btnAdd');
    const btnDownloadEl = document.getElementById('btnDownload');

    btnAdd.addEventListener('click', addEvent);
    btnDownloadEl.addEventListener('click', downloadICalFile);
    btnToggleAll.addEventListener('click', toggleSelectAll);
    btnDeleteSelected.addEventListener('click', deleteSelected);
    btnToggleCsv.addEventListener('click', () => {
      csvPanel.classList.toggle('hidden');
      state.showCsvPanel = !csvPanel.classList.contains('hidden');
      if (!csvPanel.classList.contains('hidden')) {
        csvText.focus();
      }
      render();
    });
    btnQuickAdd.addEventListener('click', quickAddEvent);
    btnSavePreset.addEventListener('click', savePresetFromForm);
    btnApplyBulk.addEventListener('click', applyBulkEdit);
    btnImportCsv.addEventListener('click', () => {
      const text = csvText.value.trim();
      if (text) {
        setCsvProgress(null, 'Importing pasted CSV‚Ä¶');
        importCsvText(text);
        csvText.value = '';
        setCsvProgress(100, 'Import complete');
        setTimeout(resetCsvProgress, 600);
      }
    });
    btnDownloadCsvTemplate.addEventListener('click', downloadCsvTemplate);
    csvFile.addEventListener('change', async (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      setCsvProgress(0, 'Reading file‚Ä¶');
      const reader = new FileReader();
      reader.onprogress = (evt) => {
        if (evt.lengthComputable) {
          setCsvProgress((evt.loaded / evt.total) * 100, 'Reading file‚Ä¶');
        } else {
          setCsvProgress(null, 'Reading file‚Ä¶');
        }
      };
      reader.onerror = () => {
        setCsvProgress(0, 'Failed to read file');
        setTimeout(resetCsvProgress, 800);
      };
      reader.onload = () => {
        setCsvProgress(100, 'Importing‚Ä¶');
        importCsvText(String(reader.result || ''));
        csvFile.value = '';
        setCsvProgress(100, 'Import complete');
        setTimeout(resetCsvProgress, 600);
      };
      reader.readAsText(file);
    });

    viewCardsBtn.addEventListener('click', () => {
      state.view = 'cards';
      viewCardsBtn.classList.add('bg-white');
      viewListBtn.classList.remove('bg-white');
      viewCalendarBtn.classList.remove('bg-white');
      render();
    });
    viewListBtn.addEventListener('click', () => {
      state.view = 'list';
      viewListBtn.classList.add('bg-white');
      viewCardsBtn.classList.remove('bg-white');
      viewCalendarBtn.classList.remove('bg-white');
      render();
    });
    viewCalendarBtn.addEventListener('click', () => {
      state.view = 'calendar';
      viewCalendarBtn.classList.add('bg-white');
      viewCardsBtn.classList.remove('bg-white');
      viewListBtn.classList.remove('bg-white');
      render();
    });

    listToggleAllBtn.addEventListener('click', () => {
      if (state.selectedIds.size === state.events.length) state.selectedIds.clear();
      else state.selectedIds = new Set(state.events.map(e => e.id));
      render();
    });

    btnCloseModal.addEventListener('click', closeWizardInternal);
    btnCancelEvent.addEventListener('click', closeWizardInternal);
    btnSaveEvent.addEventListener('click', saveEvent);
    modalBackdrop.addEventListener('click', (e) => { if (e.target === modalBackdrop) closeWizardInternal(); });
    f_allDay.addEventListener('change', toggleAllDayUI);
    f_startDate.addEventListener('change', () => {
      const startVal = f_startDate.value;
      if (!f_endDate.value || f_endDate.value === lastStartDateValue) {
        f_endDate.value = startVal;
      }
      lastStartDateValue = startVal;
    });

    // Allow Enter key to save from Title field
    f_title.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); saveEvent(); }
    });

    // Initial render & icons
    loadPresets();
    render();
    if (window.lucide && typeof lucide.createIcons === 'function') {
      lucide.createIcons();
    }
  </script>
</body>
</html>
